<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
</head>

<body>

  <!-- Styles for the app -->
  <!-- TODO move into its own file -->
  <style>
    /* Parent div  */
    body {
      overflow: hidden;
      margin: 5px;
      height: 100vh;
    }

    .container {
      display: flex;
      width: 100%;
      height: 100vh;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    /* Main div - always on screen  */
    #main_div {
      flex: 1;
      z-index: 1;
      transition: width 0.3s ease;
      padding-right: 15px;
      overflow-y: auto;
      max-height: 100vh;
    }

    #integration_selection_dropdown {
      width: 100%;
      max-width: 400px;
      padding: 10px 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #fff;
      font-size: 16px;
      color: #333;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      appearance: none;
      cursor: pointer;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    /* Add these styles for the refresh button */
    .refresh-btn {
      background: linear-gradient(to right, #03a9f4, #00bcd4);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      margin-left: 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .refresh-btn:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    .refresh-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .refresh-btn svg {
      width: 16px;
      height: 16px;
      transition: transform 0.5s ease;
    }

    .refresh-btn:hover svg {
      transform: rotate(360deg);
    }

    /* Update loader styles for better visibility */
    .loader-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 30px;
      width: 100%;
    }

    .loader {
      border: 4px solid #f3f3f3;
      /* Light grey */
      border-top: 4px solid #03a9f4;
      /* Blue */
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1.5s linear infinite;
    }

    /* Smaller loader for inline use */
    .loader-sm {
      border-width: 3px;
      width: 20px;
      height: 20px;
    }

    /* Button with loader */
    .btn-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.8;
    }

    .btn-loading .loader-sm {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Integration's details table, top table displays the bundles info */
    #integration_bundles_table {
      width: 100%;
      table-layout: fixed;
      border-collapse: separate;
      border-spacing: 0;
      margin-bottom: 20px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    /* Set specific widths for the main table columns */
    /* UUID column */
    #integration_bundles_table th:nth-child(1),
    #integration_bundles_table td:nth-child(1) {
      width: 25%;
    }

    /* Name column */
    #integration_bundles_table th:nth-child(2),
    #integration_bundles_table td:nth-child(2) {
      width: 20%;
    }

    /* Description column */
    #integration_bundles_table th:nth-child(3),
    #integration_bundles_table td:nth-child(3) {
      width: 25%;
    }

    /* Jobspecs column */
    #integration_bundles_table th:nth-child(4),
    #integration_bundles_table td:nth-child(4) {
      width: 12%;
      text-align: center;
    }

    /* Action column */
    #integration_bundles_table th:nth-child(5),
    #integration_bundles_table td:nth-child(5) {
      width: 12%;
      text-align: center;
    }

    /* Uninstall column */
    #integration_bundles_table th:nth-child(6),
    #integration_bundles_table td:nth-child(6) {
      width: 5%;
      text-align: center;
    }

    #integration_bundles_table_header_row {
      background: linear-gradient(to right, #03a9f4, #00bcd4);
      color: white;
    }

    #integration_bundles_table_header_row th {
      text-align: left;
      padding: 12px 15px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      font-size: 14px;
    }

    .integration_bundles_table_body_row {
      background-color: white;
      transition: all 0.2s ease;
    }

    .integration_bundles_table_body_row td {
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
      overflow-x: hidden;
      word-break: break-all;
    }

    /* Add a style for the see bundle button */
    .see-bundle-btn {
      background: linear-gradient(to right, #03a9f4, #00bcd4);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 10px;
      font-weight: 400;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .see-bundle-btn:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    .see-bundle-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Delete bundle button */
    .delete-bundle-btn {
      background-color: transparent;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #e53935;
    }

    .delete-bundle-btn svg {
      width: 18px;
      height: 18px;
      transition: all 0.2s ease;
    }

    .delete-bundle-btn:hover {
      background-color: rgba(229, 57, 53, 0.1);
      transform: scale(1.1);
    }

    .delete-bundle-btn:hover svg {
      color: #c62828;
    }

    .delete-bundle-btn:active {
      transform: scale(0.95);
    }

    /* Inner table showing the job spec details */
    .integration_bundles_inner_table {
      width: 100%;
      table-layout: fixed;
      border-collapse: separate;
      border-spacing: 0;
      border-radius: 8px;
      overflow: auto;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      margin-top: 5px;
      margin-bottom: 10px;
    }

    .integration_bundles_inner_table_header_row {
      background: linear-gradient(to right, #4db6ac, #26a69a);
      color: white;
    }

    .integration_bundles_inner_table_row th {
      text-align: left;
      padding: 10px 15px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      font-size: 12px;
    }

    /* Set specific widths for columns */
    /* Jobspec name */
    .integration_bundles_inner_table th:nth-child(1),
    .integration_bundles_inner_table td:nth-child(1) {
      width: 30%;
    }

    /* Jobspec event source */
    .integration_bundles_inner_table th:nth-child(2),
    .integration_bundles_inner_table td:nth-child(2) {
      width: 20%;
    }

    /* Jobspec event type */
    .integration_bundles_inner_table th:nth-child(3),
    .integration_bundles_inner_table td:nth-child(3) {
      width: 20%;
    }

    /* Jobspec installation status */
    .integration_bundles_inner_table th:nth-child(4),
    .integration_bundles_inner_table td:nth-child(4) {
      width: 20%;
      text-align: center;
    }

    .integration_bundles_inner_table th:nth-child(5),
    .integration_bundles_inner_table td:nth-child(5) {
      width: 10%;
      text-align: center;
    }

    .integration_bundles_inner_table_body_row {
      background-color: white;
      transition: all 0.2s ease;
    }

    .integration_bundles_inner_table_body_row:hover {
      background-color: #f9f9f9;
    }

    .integration_bundles_inner_table_body_row td {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      font-size: 13px;
    }

    .integration_bundles_inner_table_body_row_installed_span {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    /* Container for the inner table */
    .jobspec-container {
      padding: 15px 20px;
      background-color: #f5f7fa;
      border-bottom: 1px solid #e0e0e0;
      border-left: 4px solid #26a69a;
      transition: all 0.3s ease;
    }

    .jobspec-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }

    .jobspec-title svg {
      margin-right: 8px;
      width: 16px;
      height: 16px;
      color: #26a69a;
    }

    /* Row inly displayed when there's no bundle */

    #no_bundle_row {
      padding: 12px 15px;
      text-align: center;
      color: #999;
    }

    /* Preview div content - only shown if something to preview  */
    #preview_div {
      z-index: 1000;
      width: 0;
      display: none;
      overflow-y: auto;
      max-height: 100vh;
      transition: all 0.3s ease;
      padding: 20px;
      background-color: #f5f5f5;
      border-radius: 8px;
      border: 1px solid #eaeaea;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      font-size: 14px;
      line-height: 1.6;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    }

    #preview_div.active {
      width: 40%;
      display: block;
      /* position:absolute; *//* If we want to display over the main div and avoid resize */
      top: 0;
      right: 0;
      overflow-y: auto;
    }

    #preview_div.expanded {
      width: 95% !important;
    }

    /* Icon buttons in the preview to copy or close the preview*/
    .icon_btn {
      background-color: transparent;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.2s;
      position: absolute;
    }

    .icon_btn:hover {
      background-color: rgba(0, 0, 0, 0.05);
      transform: scale(1.1);
    }

    .icon_btn svg {
      width: 20px;
      height: 20px;
    }

    .expand_btn {
      top: 20px;
      align-items: center;
      color: #5c5e5c;
    }

    .copy_btn {
      top: 20px;
      right: 50px;
      color: #5c5e5c;
    }

    .close_btn {
      top: 20px;
      right: 20px;
      color: #5c5e5c;
    }
  </style>

  <script src="https://static.zdassets.com/zendesk_app_framework_sdk/2.0/zaf_sdk.min.js"></script>

  <!-- Vue.js -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <div id="app-vue">
    <div class="container">

      <div id="main_div">

        <div style="padding: 20px; display: flex; flex-direction: row; align-items: normal;">
          <select id="integration_selection_dropdown" v-model="selectedIntegrationName">
            <option disabled value="">Please select an integration</option>
            <option v-for="option in integrations" :value="option.name" style="padding: 8px;">
              {{ option.name }}
            </option>
          </select>
          <button @click="refreshData" class="refresh-btn" :class="{'btn-loading': isLoading}" :disabled="isLoading"
            title="Refresh data">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M23 4v6h-6"></path>
              <path d="M1 20v-6h6"></path>
              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
          </button>
          <button v-if="settings.allow_bundle_upload && selectedIntegrationName" @click="uploadBundle" class="refresh-btn" :class="{'btn-loading': isLoading}" :disabled="isLoading"
            title="Upload bundle">
            Upload bundle
          </button>
        </div>

        <div v-if="selectedIntegrationName" style="padding-top: 10px;">
          <table id="integration_bundles_table">
            <thead>
              <tr id="integration_bundles_table_header_row">
                <th>uuid</th>
                <th>name</th>
                <th>description</th>
                <th>jobspecs</th>
                <th></th>
                <th v-if="settings.allow_bundle_deletion"></th>
              </tr>
            </thead>
            <tbody>
              <!-- Loading state -->
              <tr v-if="isLoading">
                <td colspan="6">
                  <div class="loader-container">
                    <div class="loader"></div>
                  </div>
                </td>
              </tr>
              <!-- Data state -->
              <template v-else-if="bundles && bundles.length > 0" v-for="bundle in bundles" :key="bundle.uuid">
                <tr class="integration_bundles_table_body_row">
                  <td>{{ bundle.uuid }}</td>
                  <td>{{ bundle.name }}</td>
                  <td>{{ bundle.description }}</td>
                  <td style="cursor: pointer; color: #03a9f4;" @click="showJobspecClicked(bundle.uuid)">
                    {{ showJobSpecFor.includes(bundle.uuid) ? 'Hide' : `Show ${bundle.job_specs.length}` }}
                  </td>
                  <td>
                    <button @click="showBundleClicked(bundle.uuid)" class="see-bundle-btn">
                      {{ shownBundleID != bundle.uuid ? 'See Bundle' : 'Hide Bundle' }}
                    </button>
                  </td>
                  <td v-if="settings.allow_bundle_deletion">
                    <button @click="deleteBundle(bundle.uuid)" class="delete-bundle-btn" title="Uninstall bundle">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                      </svg>
                    </button>
                  </td>
                </tr>

                <!-- Inner table showing the job specs for the selected bundle -->
                <tr v-if="showJobSpecFor.includes(bundle.uuid)">
                  <td colspan="6" style="padding: 0;">
                    <div class="jobspec-container">
                      <div class="jobspec-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                          <polyline points="14 2 14 8 20 8"></polyline>
                          <line x1="16" y1="13" x2="8" y2="13"></line>
                          <line x1="16" y1="17" x2="8" y2="17"></line>
                          <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        Job Specifications
                      </div>
                      <table class="integration_bundles_inner_table">
                        <thead>
                          <tr class="integration_bundles_inner_table_header_row integration_bundles_inner_table_row">
                            <th>Job Name</th>
                            <th>Event Source</th>
                            <th>Event Type</th>
                            <th>Status</th>
                            <th v-if="settings.allow_jobspec_update">Update</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr v-for="job in bundle.job_specs" :key="job.uuid"
                            class="integration_bundles_inner_table_body_row">
                            <td>{{ job.name }}</td>
                            <td>{{ job.event_source }}</td>
                            <td>{{ job.event_type }}</td>
                            <td>
                              <span class="integration_bundles_inner_table_body_row_installed_span" :style="{
                                backgroundColor: job.installed ? '#e3fcef' : '#fff4e5',
                                color: job.installed ? '#0b875b' : '#e65100'
                              }">
                                {{ job.installed ? 'Installed' : 'Not Installed' }}
                              </span>
                            </td>
                            <td v-if="settings.allow_jobspec_update">
                              <button v-if="!job.installed" @click="updateJobspec('install', job.name)"
                                class="see-bundle-btn" :class="{'btn-loading': isLoading}" 
                                :disabled="isLoading">Install</button>
                              <button v-else @click="updateJobspec('uninstall', job.name)"
                                class="see-bundle-btn" :class="{'btn-loading': isLoading}" 
                                :disabled="isLoading">Uninstall</button>
                            </td>
                          </tr>
                          <tr v-if="bundle.job_specs.length === 0">
                            <td colspan="5" style="text-align: center; padding: 15px; color: #888;">
                              No job specifications available for this bundle.
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </td>
                </tr>
              </template>
              <!-- Empty state -->
              <tr v-else>
                <td id="no_bundle_row" colspan="6">No bundles available for this integration.</td>
              </tr>

            </tbody>
          </table>
        </div>

      </div> <!-- End of main_div -->

      <!-- Preview Div - hidden until the "see bundle" button is tapped to show the preview -->
      <div id="preview_div" v-if="shownBundleID" :class="{ active: shownBundleID, expanded: isPreviewExpanded }">
        <pre>{{ bundles.find(bundle => bundle.uuid == shownBundleID).content }}</pre>

        <button @click="togglePreviewExpansion" class="icon_btn expand_btn" title="Expand/Collapse preview">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round"
            :style="{transform: isPreviewExpanded ? 'rotate(180deg)' : 'rotate(0deg)'}">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>

        <button @click="copyToClipboard(bundles.find(bundle => bundle.uuid == shownBundleID).content)"
          class="icon_btn copy_btn" title="Copy to clipboard">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
        </button>

        <button @click="shownBundleID = ''" class="icon_btn close_btn" title="Close preview">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <!-- Vue and JS -->
      <script type="module">
        // Importing necessary functions from the Zendesk API script
        import {
          // Initialization functions
          initClient,
          getAppSettings,
          // API functions
          fetchIntegrations,
          fetchBundles,
          fetchBundle,
          fetchJobspecs,
          // Data manipulation functions
          reconcileJobspecsToBundles,
          // UI functions
          openActionModal,
          displayZendeskNotification
        } from './scripts/zendesk_api.js'

        const { createApp, ref, watch } = Vue

        await initClient() // Initialize the Zendesk client
        const settings = await getAppSettings() // Fetch app settings from manifest

        const integrations = ref([])
        const bundles = ref([]) // List of bundles for the selected integration - Array
        const isLoading = ref(false)

        integrations.value = await fetchIntegrations()

        const selectedIntegrationName = ref('') // Name of the selected integration - Comes from the dropdown - String
        watch(selectedIntegrationName, async (newValue) => {
          //console.log("Selected integration changed to:", newValue)
          isLoading.value = true
          fetchBundlesAndJobspecsThenReconcile(newValue)
        })

        const fetchBundlesAndJobspecsThenReconcile = async (integrationName) => {
          if (!integrationName) {
            console.warn('No integration provided, cannot fetch bundles and jobspecs')
            isLoading.value = false
            return
          }
          const fetchedBundles = await fetchBundles(integrationName)
          const fetchedJobspecs = await fetchJobspecs(integrationName)

          for (const bundle of fetchedBundles) {
            const bundleContent = await fetchBundle(integrationName, bundle.uuid)
            bundle.content = bundleContent // Add content to each bundle
          }
          bundles.value = reconcileJobspecsToBundles(fetchedBundles, fetchedJobspecs)
          isLoading.value = false
        }

        const showJobSpecFor = ref([]) // List of bundle UUIDs for which job specs are shown - Array
        const showJobspecClicked = (bundleId) => {
          if (!bundleId) {
            console.error('No UUID provided for bundle jobspecs')
            return
          }
          showJobSpecFor.value.includes(bundleId) ?
            showJobSpecFor.value = showJobSpecFor.value.filter(id => id !== bundleId) :
            showJobSpecFor.value.push(bundleId)

          console.log("SelectedBundle:", bundleId)
        }

        const shownBundleID = ref('') // ID of the bundle currently shown in the preview - String
        const showBundleClicked = (bundleId) => {

          shownBundleID.value === bundleId ?
            shownBundleID.value = "" :
            shownBundleID.value = bundleId

        }

        // Function to refresh data
        // Will refresh all data from intregations to bundles and jobspecs and update the UI to match
        const refreshData = async () => {

          isLoading.value = true
          // 1. Refresh the integration bundles and jobspecs
          integrations.value = await fetchIntegrations()

          // 2. Check if there are any integrations available
          if (integrations.value.length === 0) {
            console.warn('No integrations available')
            return
          }

          // 3. Fetched bundles and jobspecs and reconcile them
          await fetchBundlesAndJobspecsThenReconcile(selectedIntegrationName.value)

          // 4. Check if the bundles that were displaying jobspecs and/or preview are still available
          if (showJobSpecFor.value.length > 0) {
            showJobSpecFor.value = showJobSpecFor.value.filter(bundleId =>
              bundles.value.some(bundle => bundle.uuid === bundleId)
            )
          }
          if (shownBundleID.value && !bundles.value.some(bundle => bundle.uuid === shownBundleID.value)) {
            shownBundleID.value = ''
          }

          isLoading.value = false
          console.log("Data refreshed")

        }

        // Toggle the preview expansion
        const isPreviewExpanded = ref(false)
        export const togglePreviewExpansion = () => {

          isPreviewExpanded.value = !isPreviewExpanded.value
          const mainDiv = document.getElementById('main_div')

          if (isPreviewExpanded.value) {
            mainDiv.classList.add('contracted')
          } else {
            mainDiv.classList.remove('contracted')
          }

        }

        //Clipboard 
        export const copyToClipboard = (text) => {

          if (!text) {
            console.error('No text to copy')
            return
          }
          if (typeof text == "object")
            text = JSON.stringify(text, null, 2) // Convert object to formatted string
          else if (typeof text != "string")
            text = String(text) // Ensure it's a string

          navigator.clipboard.writeText(text).then(() => {
            console.log('Copied to clipboard')
            displayZendeskNotification('Copied to clipboard', 'success')
          }).catch(err => {
            console.error('Failed to copy text:', err)
          })

        }

        // Modal actions
        const updateJobspec = async (action, jobspecName) => {
          if (!selectedIntegrationName.value || !jobspecName || !action) {
            console.error('Integration name, jobspec name or action is missing')
            return
          }
          openActionModal(
            selectedIntegrationName.value,
            action,
            jobspecName,
            null,
            refreshData
          )
        }
        const uploadBundle = async () => {
          openActionModal(
            selectedIntegrationName.value,
            'install',
            null,
            1, // There's no bundle ID for upload, so we pass 1 - this is used later to identify an upload
            refreshData
          )
        }
        const deleteBundle = async (bundleId) => {
          if (!selectedIntegrationName.value || !bundleId) {
            console.error('Integration name, bundle id or action is missing')
            return
          }
          showJobSpecFor.value.filter(id => id !== bundleId) // Remove the bundle from the list of shown jobspecs
          if (shownBundleID.value === bundleId) {
            shownBundleID.value = '' // Hide the preview if it was showing this bundle
          }
          openActionModal(
            selectedIntegrationName.value,
            'uninstall',
            null,
            bundleId,
            refreshData
          )
        }

        // Create Vue app
        createApp({
          setup() {
            return {
              //App settings
              settings,
              // Data
              integrations,
              bundles,
              // UI
              isLoading,
              selectedIntegrationName,
              showJobSpecFor,
              shownBundleID,
              isPreviewExpanded,
              // Functions
              showJobspecClicked,
              showBundleClicked,
              refreshData,
              togglePreviewExpansion,
              copyToClipboard,
              // Modal
              updateJobspec,
              uploadBundle,
              deleteBundle
            }
          }
        }).mount('#app-vue')
      </script>

    </div> <!-- End of container -->

  </div> <!-- End of app_vue -->

</body>

</html>