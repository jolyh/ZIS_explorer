<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
</head>

<body>

  <!-- Styles for the app -->
  <!-- TODO move into its own file -->
  <style>
    /* Parent div  */
    body {
      overflow: hidden;
      margin: 5px;
      height: 100vh;
    }

    .container {
      display: flex;
      width: 100%;
      height: 100vh;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    /* Main div - always on screen  */
    #main_div {
      flex: 1;
      z-index: 1;
      transition: width 0.3s ease;
      padding-right: 15px;
      overflow-y: auto;
      max-height: 100vh;
    }

    #integration_selection_dropdown {
      width: 100%;
      max-width: 400px;
      padding: 10px 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #fff;
      font-size: 16px;
      color: #333;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      appearance: none;
      cursor: pointer;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    /* Integration's details table, top table displays the bundles info */
    #integration_bundles_table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-bottom: 20px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    #integration_bundles_table_header_row {
      background: linear-gradient(to right, #03a9f4, #00bcd4);
      color: white;
    }

    #integration_bundles_table_header_row th {
      text-align: left;
      padding: 12px 15px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      font-size: 14px;
    }

    .integration_bundles_table_body_row {
      background-color: white;
      transition: all 0.2s ease;
    }

    .integration_bundles_table_body_row td {
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
    }

    /* Add a style for the see bundle button */
    .see-bundle-btn {
      background: linear-gradient(to right, #03a9f4, #00bcd4);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 10px;
      font-weight: 400;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
  
    .see-bundle-btn:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }
    
    .see-bundle-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Inner table showing the job spec details */
    .integration_bundles_inner_table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .integration_bundles_inner_table_header_row {
      background-color: #e0e0e0;
    }

    .integration_bundles_inner_table_row th {
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
    }

    .integration_bundles_inner_table_body_row {
      background-color: white;
    }

    .integration_bundles_inner_table_body_row td {
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
    }

    .integration_bundles_inner_table_body_row_installed_span {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    #no_bundle_row{
      padding: 12px 15px; 
      text-align: center; 
      color: #999;
    }

    /* Preview div content - only shown if something to preview  */      
    #preview_div {
      z-index: 1000;
      width: 0;
      display: none;
      overflow-y: auto;
      max-height: 100vh;
      transition: all 0.3s ease;
      padding: 20px;
      background-color: #f5f5f5;
      border-radius: 8px;
      border: 1px solid #eaeaea;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      font-size: 14px;
      line-height: 1.6;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    }

    #preview_div.active {
      width: 40%;
      display: block;
      top: 0;
      right: 0;
      overflow-y: auto;
    }

    #preview_div.expanded {
        width: 95% !important;
    }

    /* Icon buttons in the preview to copy or close the preview*/
    .icon_btn {
      background-color: transparent;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.2s;
      position: absolute;
    }

    .icon_btn:hover {
      background-color: rgba(0, 0, 0, 0.05);
      transform: scale(1.1);
    }

    .icon_btn svg {
      width: 20px;
      height: 20px;
    }

    .expand_btn {
      top: 20px;
      align-items: center;
      color: #5c5e5c;
    }

    .copy_btn {
      top: 20px;
      right: 50px;
      color: #5c5e5c;
    }

    .close_btn {
      top: 20px;
      right: 20px;
      color: #5c5e5c;
    }
  </style>

  <script src="https://static.zdassets.com/zendesk_app_framework_sdk/2.0/zaf_sdk.min.js"></script>

  <!-- Vue.js -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <div id="app-vue">
    <div class="container">

      <div id="main_div">

        <select id="integration_selection_dropdown" v-model="selectedIntegrationName">
          <option disabled value="">Please select an integration</option>
          <option v-for="option in integrations" :value="option.name" style="padding: 8px;">
            {{ option.name }}
          </option>
        </select>

        <div v-if="selectedIntegrationName" style="padding-top: 10px;">
          <table id="integration_bundles_table">
            <thead>
              <tr id="integration_bundles_table_header_row">
                <th>uuid</th>
                <th>name</th>
                <th>description</th>
                <th>jobspecs</th>
                <th></th>
              </tr>
            </thead>
            <tbody>

              <template v-if="bundles" v-for="bundle in bundles" :key="bundle.uuid">
                <tr class="integration_bundles_table_body_row">
                  <td>{{ bundle.uuid }}</td>
                  <td>{{ bundle.name }}</td>
                  <td>{{ bundle.description }}</td>
                  <td style="cursor: pointer; color: #03a9f4;" @click.stop="showJobspecForBundle(bundle.uuid)">
                    {{ selectedBundle === bundle.uuid ? 'Hide Jobspecs' : `Show ${bundle.job_specs.length} Jobspecs` }}
                  </td>
                  <td> 
                    <button @click="previewBundleContent(bundle.uuid)" class="see-bundle-btn"> See Bundle </button>
                  </td>
                </tr>

                <!-- Inner table showing the job specs for the selected bundle -->
                <!-- Only show if the bundle is selected -->
                <!-- TODO: some design for the inner table -->
                <tr v-if="selectedBundle === bundle.uuid" style="background-color: #f9f9f9;">
                  <td colspan="5" style="padding: 0;">
                    <div style="padding: 15px; border-bottom: 1px solid #eaeaea;">
                      <table class="integration_bundles_inner_table">
                        <thead>
                          <tr class="integration_bundles_inner_table_header_row">
                            <th>Job_spec</th>
                            <th>Event source</th>
                            <th>Event type</th>
                            <th>Status</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr v-for="job in bundle.job_specs" :key="job.uuid" class="integration_bundles_inner_table_body_row">
                            <td>{{ job.name }}</td>
                            <td>{{ job.event_source }}</td>
                            <td>{{ job.event_type }}</td>
                            <td>
                              <span class="integration_bundles_inner_table_body_row_installed_span" :style="{
                                backgroundColor: job.installed ? '#e3fcef' : '#fff4e5',
                                color: job.installed ? '#0b875b' : '#e65100'
                              }">
                                {{ job.installed ? 'Installed' : 'Not Installed' }}
                              </span>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </td>
                </tr>

              </template>
              <tr v-if="bundles.length === 0">
                <td id="no_bundle_row" colspan="5">No bundles available for this integration.</td>
              </tr>
            </tbody>
          </table>
        </div>

      </div> <!-- End of main_div -->

      <!-- Preview Div - hidden until the "see bundle" button is tapped to show the preview -->
      <div id="preview_div" :class="{ active: isBundleShown, expanded: isPreviewExpanded }">
        <pre>{{ selectedBundleContent }}</pre>

        <button @click="togglePreviewExpansion" class="icon_btn expand_btn" title="Expand/Collapse preview">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round" :style="{transform: isPreviewExpanded ? 'rotate(180deg)' : 'rotate(0deg)'}">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>

        <button @click="copyToClipboard(selectedBundleContent)" class="icon_btn copy_btn" title="Copy to clipboard">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
        </button>

        <button @click="isBundleShown = false" class="icon_btn close_btn" title="Close preview">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <!-- Vue and JS -->
      <script type="module">
        // Importing necessary functions from the Zendesk API script
        import {
          fetchIntegrations,
          fetchIntegrationBundles,
          fetchIntegrationJobspecs,
          reconcileJobspecsToBundles,
          fetchIntegrationBundleById
        } from './scripts/zendesk_api.js'

        const { createApp, ref, watch } = Vue

        // TODO for error handling
        const error = ref([])

        const integrations = ref([])
        integrations.value = await fetchIntegrations()
        const selectedIntegrationName = ref('')//integrations.value[0].name)

        const bundles = ref([]) // List of bundles for the selected integration - Array
        const selectedBundle = ref('') // Currently selected bundle uuid - selectec when jobspec is selected - String
        const selectedBundleContent = ref('') // When show bundle is shown  - selectec when jobspec is selected - String
        const isBundleShown = ref(false)

        console.log("integration example", integrations.value[0])

        watch(selectedIntegrationName, async (newValue) => {
          console.log("Selected integration changed to:", newValue)
          const fetchedBundles = await fetchIntegrationBundles(newValue) // Fetch all bundles from integration in []
          const fetchedJobspecs = await fetchIntegrationJobspecs(newValue) // Fetch all jobspecs from integration in [] - No link to which bundle

          for (const bundle of fetchedBundles) {
            const bundleContent = await fetchIntegrationBundleById(newValue, bundle.uuid)
            bundle.content = bundleContent // Add content to each bundle
          }

          // Reconcile jobspecs to bundles
          bundles.value = reconcileJobspecsToBundles(fetchedBundles, fetchedJobspecs)
        })

        // TODO: improve the system, use watch instead for selectedBundle?
        export const showJobspecForBundle = (uuid) => {
          if (selectedBundle.value === uuid) {
            selectedBundle.value = ''
          } else {
            selectedBundle.value = uuid
          }
          console.log("SelectedBundle:", uuid)
        }
        // TODO: could be regrouped inside a watch to preload the content and have the button only update isBundleShown?
        export const previewBundleContent = (uuid) => {

          if (!uuid) {
            console.error('No UUID provided for bundle preview')
            return
          }
          if (isBundleShown.value) {
            isBundleShown.value = !isBundleShown.value
            return
          }

          console.log("Previewing bundle content for UUID:", uuid)
          selectedBundleContent.value = bundles.value.find(bundle => bundle.uuid === uuid)?.content || ''
          isBundleShown.value = true

        }

        // Toggle the preview expansion
        const isPreviewExpanded = ref(false)
        export const togglePreviewExpansion = () => {

          isPreviewExpanded.value = !isPreviewExpanded.value
          const mainDiv = document.getElementById('main_div')
          
          if (isPreviewExpanded.value) {
            mainDiv.classList.add('contracted')
          } else {
            mainDiv.classList.remove('contracted')
          }

        }
  
        //Clipboard 
        export const copyToClipboard = (text) => {

          if (!text) {
            console.error('No text to copy')
            return
          }
          if (typeof text == "object")
            text = JSON.stringify(text, null, 2) // Convert object to formatted string
          else if (typeof text != "string")
            text = String(text) // Ensure it's a string

          navigator.clipboard.writeText(text).then(() => {
            console.log('Copied to clipboard')
          }).catch(err => {
            console.error('Failed to copy text:', err)
          })

        }

        // Create Vue app
        createApp({
          setup() {
            const message = ref('Integrations List')
            return {
              error, // unused for now, but can be used for error handling
              integrations,
              selectedIntegrationName,
              bundles,
              selectedBundle,
              selectedBundleContent,
              isBundleShown,
              isPreviewExpanded,
              showJobspecForBundle,
              previewBundleContent,
              togglePreviewExpansion,
              copyToClipboard
            }
          }
        }).mount('#app-vue')
      </script>

    </div> <!-- End of container -->

  </div> <!-- End of app_vue -->

</body>

</html>