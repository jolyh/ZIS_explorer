<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
</head>

<body>

  <!-- Styles for the app -->
  <!-- TODO move into its own file -->
  <!--link rel="stylesheet" href="./styles/iframe.css"-->
  <style>
    /* Parent div  */
    body {
      overflow: hidden;
      margin: 5px;
      height: 100vh;
    }

    .container {
      display: flex;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }

    /* Main div - always on screen  */
    #main_div {
      flex: 1;
      z-index: 1;
      padding-right: 15px;
      overflow-y: auto;
      max-height: 100vh;
    }

    #main_div.contracted {
      width: 0;
      padding: 0;
      transition: width 0.3s ease;
    }

    .buttons-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: normal;
      padding: 10px 0px;
    }

    #integration_selection_dropdown {
      width: 100%;
      max-width: 400px;
      padding: 10px 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #fff;
      font-size: 16px;
      color: #333;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      appearance: none;
      cursor: pointer;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    /* Add these styles for the refresh button */
    .buttons-container button {
      background: linear-gradient(to right, #03a9f4, #00bcd4);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      margin-left: 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .refresh-btn:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    .refresh-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .refresh-btn svg {
      width: 16px;
      height: 16px;
      transition: transform 0.5s ease;
    }

    .refresh-btn:hover svg {
      transform: rotate(360deg);
    }

    /* Update loader styles for better visibility */
    .loader-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 30px;
      width: 100%;
    }

    .loader {
      border: 4px solid #f3f3f3;
      /* Light grey */
      border-top: 4px solid #03a9f4;
      /* Blue */
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1.5s linear infinite;
    }

    /* Smaller loader for inline use */
    .loader-sm {
      border-width: 3px;
      width: 20px;
      height: 20px;
    }

    /* Button with loader */
    .btn-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.8;
    }

    .btn-loading .loader-sm {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Integration's details table, top table displays the bundles info */
    #integration_bundles_table {
      width: 100%;
      table-layout: fixed;
      border-collapse: separate;
      border-spacing: 0;
      margin-bottom: 20px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    /* Set specific widths for the main table columns */
    /* UUID column */
    #integration_bundles_table th:nth-child(1),
    #integration_bundles_table td:nth-child(1) {
      width: 25%;
    }

    /* Name column */
    #integration_bundles_table th:nth-child(2),
    #integration_bundles_table td:nth-child(2) {
      width: 20%;
    }

    /* Description column */
    #integration_bundles_table th:nth-child(3),
    #integration_bundles_table td:nth-child(3) {
      width: 25%;
    }

    /* Jobspecs column */
    #integration_bundles_table th:nth-child(4),
    #integration_bundles_table td:nth-child(4) {
      width: 12%;
      text-align: center;
    }

    /* Action column */
    #integration_bundles_table th:nth-child(5),
    #integration_bundles_table td:nth-child(5) {
      width: 12%;
      text-align: center;
    }

    /* Uninstall column */
    #integration_bundles_table th:nth-child(6),
    #integration_bundles_table td:nth-child(6) {
      width: 5%;
      text-align: center;
    }

    #integration_bundles_table_header_row {
      background: linear-gradient(to right, #03a9f4, #00bcd4);
      color: white;
    }

    #integration_bundles_table_header_row th {
      text-align: left;
      padding: 12px 15px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      font-size: 14px;
    }

    .integration_bundles_table_body_row {
      background-color: white;
      transition: all 0.2s ease;
    }

    .integration_bundles_table_body_row td {
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
      overflow-x: hidden;
      word-break: break-all;
    }

    /* Add a style for the see bundle button */
    .see-bundle-btn {
      background: linear-gradient(to right, #03a9f4, #00bcd4);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 10px;
      font-weight: 400;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .see-bundle-btn:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    .see-bundle-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Delete bundle button */
    .delete-bundle-btn {
      background-color: transparent;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #e53935;
    }

    .delete-bundle-btn svg {
      width: 18px;
      height: 18px;
      transition: all 0.2s ease;
    }

    .delete-bundle-btn:hover {
      background-color: rgba(229, 57, 53, 0.1);
      transform: scale(1.1);
    }

    .delete-bundle-btn:hover svg {
      color: #c62828;
    }

    .delete-bundle-btn:active {
      transform: scale(0.95);
    }
  </style>

  <!-- Styles for the JobSpecRow component - some styling are shared with general-->
  <link rel="stylesheet" href="./styles/job-spec-table.css">

  <!-- PreviewBundleDiv component styles -->
  <link rel="stylesheet" href="./styles/preview-bundle-div.css">

  <!-- ActionModal component styles -->
  <link rel="stylesheet" href="./styles/action-modal.css">

  <script src="https://static.zdassets.com/zendesk_app_framework_sdk/2.0/zaf_sdk.min.js"></script>

  <!-- Vue.js -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <div id="app-vue">

    <div class="container">

      <div id="main_div" :class="{'contracted' : isPreviewExpanded}">

        <div class="buttons-container">
          <select id="integration_selection_dropdown" v-model="selectedIntegrationName">
            <option disabled value="">Please select an integration</option>
            <option v-for="option in integrations" :value="option.name" style="padding: 8px;">
              {{ option.name }}
            </option>
          </select>
          <button @click="refreshData" class="refresh-btn" :class="{'btn-loading': isLoading}" :disabled="isLoading"
            title="Refresh data">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M23 4v6h-6"></path>
              <path d="M1 20v-6h6"></path>
              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
          </button>
          <button v-if="settings.allow_bundle_upload && selectedIntegrationName" 
            @click="openActionModal('install', '', '1')"
            class="refresh-btn" :class="{'btn-loading': isLoading}" :disabled="isLoading" title="Upload bundle">
              Upload bundle
          </button>
          <!--Temporary - may be changed to something nicer-->
          <button v-if="settings.isDebugMode">
            CURRENTLY IN DEBUG MODE
          </button>
        </div>

        <div v-if="selectedIntegrationName" style="padding-top: 10px;">
          <table id="integration_bundles_table">
            <thead>
              <tr id="integration_bundles_table_header_row">
                <th>uuid</th>
                <th>name</th>
                <th>description</th>
                <th>jobspecs</th>
                <th></th>
                <th v-if="settings.allow_bundle_deletion"></th>
              </tr>
            </thead>
            <tbody>
              <!-- Loading state -->
              <tr v-if="isLoading">
                <td colspan="6">
                  <div class="loader-container">
                    <div class="loader"></div>
                  </div>
                </td>
              </tr>
              <!-- Data state -->
              <template v-else-if="bundles && bundles.length > 0" v-for="bundle in bundles" :key="bundle.uuid">
                <tr class="integration_bundles_table_body_row">
                  <td>{{ bundle.uuid }}</td>
                  <td>{{ bundle.name }}</td>
                  <td>{{ bundle.description }}</td>
                  <td style="cursor: pointer; color: #03a9f4;" @click="showJobspecClicked(bundle.uuid)">
                    {{ showJobSpecFor.includes(bundle.uuid) ? 'Hide' : `Show ${bundle.job_specs.length}` }}
                  </td>
                  <td>
                    <button @click="showBundleClicked(bundle.uuid)" class="see-bundle-btn">
                      {{ shownBundleID != bundle.uuid ? 'See Bundle' : 'Hide Bundle' }}
                    </button>
                  </td>
                  <td v-if="settings.allow_bundle_deletion">
                    <button @click="openActionModal('uninstall', '', bundle.uuid)" class="delete-bundle-btn" title="Uninstall bundle">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                      </svg>
                    </button>
                  </td>
                </tr>

                <!-- Inner table showing the job specs for the selected bundle -->
                <job-spec-table id="job_spec_table" v-if="showJobSpecFor.includes(bundle.uuid)" :job_specs="bundle.job_specs"
                  :settings="settings" :is_loading="isLoading" @update_jobspec="openActionModal">
                </job-spec-table>
              </template>
              <!-- Empty state -->
              <tr v-else>
                <td id="no_bundle_row" colspan="6">No bundles available for this integration.</td>
              </tr>
            </tbody>
          </table>

        </div>

      </div> <!-- End of main_div -->

      <!-- Modal for actions like update, install, uninstall -->
      <action-modal v-if="isModalOpen" id="action-modal" :integration="selectedIntegrationName" :action="modalGoal.action"
        :jobspec="modalGoal.jobspec" :bundle_id="modalGoal.bundleId" @on_confirm="modalActionConfirmation" @on_cancel="isModalOpen = false"
        :class="{ active: isModalOpen }">
      </action-modal>

      <!-- Preview Div - hidden until the "see bundle" button is tapped to show the preview -->
      <preview-bundle-div v-if="shownBundleID" id="preview_div"
        :bundle_content="bundles.find(bundle => bundle.uuid == shownBundleID).content"
        :is_preview_expanded="isPreviewExpanded" @toggle_preview_expansion="togglePreviewExpansion"
        @copy_to_clipboard="copyToClipboard" @update_shown_bundle_id="shownBundleID = ''"
        :class="{ active: shownBundleID, expanded: isPreviewExpanded }">
      </preview-bundle-div>

      <!-- Vue and JS -->
      <script type="module">
        // Importing necessary functions from the Zendesk API script
        import {
          // Initialization functions
          initClient,
          getAppSettings,
          // API functions
          fetchIntegrations,
          fetchBundles,
          fetchBundle,
          fetchJobspecs,
          // Data manipulation functions
          reconcileJobspecsToBundles,
          // Action functions
          // jobsepcs
          installJobspec,
          uninstallJobspec,
          // bundles
          uploadBundle,
          deleteBundle,
          // UI functions
          displayZendeskNotification
        } from './scripts/zendesk_api.js'

        // Importing Components
        import JobSpecTable from './components/JobSpecTable.js'
        import PreviewBundleDiv from './components/PreviewBundleDiv.js'
        import ActionModal from './components/ActionModal.js'

        const { createApp, ref, reactive, watch, onBeforeMount } = Vue

        //await initClient() // Initialize the Zendesk client
        let settings = await getAppSettings() // Fetch app settings from manifest

        const integrations = ref([])
        const bundles = ref([]) // List of bundles for the selected integration - Array
        const isLoading = ref(false)

        integrations.value = await fetchIntegrations()

        const selectedIntegrationName = ref('') // Name of the selected integration - Comes from the dropdown - String
        watch(selectedIntegrationName, async (newValue) => {
          //console.log("Selected integration changed to:", newValue)
          isLoading.value = true
          fetchBundlesAndJobspecsThenReconcile(newValue)
        })

        const fetchBundlesAndJobspecsThenReconcile = async (integrationName) => {
          if (!integrationName) {
            console.warn('No integration provided, cannot fetch bundles and jobspecs')
            isLoading.value = false
            return
          }
          const fetchedBundles = await fetchBundles(integrationName)
          const fetchedJobspecs = await fetchJobspecs(integrationName)

          for (const bundle of fetchedBundles) {
            const bundleContent = await fetchBundle(integrationName, bundle.uuid)
            bundle.content = bundleContent // Add content to each bundle
          }
          bundles.value = reconcileJobspecsToBundles(fetchedBundles, fetchedJobspecs)
          isLoading.value = false
        }

        const showJobSpecFor = ref([]) // List of bundle UUIDs for which job specs are shown - Array
        const showJobspecClicked = (bundleId) => {
          if (!bundleId) {
            console.error('No UUID provided for bundle jobspecs')
            return
          }
          showJobSpecFor.value.includes(bundleId) ?
            showJobSpecFor.value = showJobSpecFor.value.filter(id => id !== bundleId) :
            showJobSpecFor.value.push(bundleId)

          console.log("SelectedBundle:", bundleId)
        }

        const shownBundleID = ref('') // ID of the bundle currently shown in the preview - String
        const showBundleClicked = (bundleId) => {

          shownBundleID.value === bundleId ?
            shownBundleID.value = "" :
            shownBundleID.value = bundleId

        }

        // Function to refresh data
        // Will refresh all data from intregations to bundles and jobspecs and update the UI to match
        const refreshData = async () => {

          isLoading.value = true
          // 1. Refresh the integration bundles and jobspecs
          integrations.value = await fetchIntegrations()

          // 2. Check if there are any integrations available
          if (integrations.value.length === 0) {
            console.warn('No integrations available')
            return
          }

          // 3. Fetched bundles and jobspecs and reconcile them
          await fetchBundlesAndJobspecsThenReconcile(selectedIntegrationName.value)

          // 4. Check if the bundles that were displaying jobspecs and/or preview are still available
          if (showJobSpecFor.value.length > 0) {
            showJobSpecFor.value = showJobSpecFor.value.filter(bundleId =>
              bundles.value.some(bundle => bundle.uuid === bundleId)
            )
          }
          if (shownBundleID.value && !bundles.value.some(bundle => bundle.uuid === shownBundleID.value)) {
            shownBundleID.value = ''
          }

          isLoading.value = false
          console.log("Data refreshed")

        }

        // Toggle the preview expansion
        const isPreviewExpanded = ref(false)
        export const togglePreviewExpansion = () => {

          isPreviewExpanded.value = !isPreviewExpanded.value
          const mainDiv = document.getElementById('main_div')

          if (isPreviewExpanded.value) {
            mainDiv.classList.add('contracted')
          } else {
            mainDiv.classList.remove('contracted')
          }

        }

        //Clipboard 
        export const copyToClipboard = (text) => {
          if (!text) {
            console.error('No text to copy')
            return
          }
          if (typeof text == "object")
            text = JSON.stringify(text, null, 2) // Convert object to formatted string
          else if (typeof text != "string")
            text = String(text) // Ensure it's a string

          navigator.clipboard.writeText(text).then(() => {
            console.log('Copied to clipboard')
            displayZendeskNotification('Copied to clipboard', 'success')
          }).catch(err => {
            console.error('Failed to copy text:', err)
          })
        }

        // Modal actions
        const isModalOpen = ref(false)
        const modalGoal = reactive({
          action: '',
          jobspec: '',
          bundleId: '',
        })
        const openActionModal = (action, jobspec, bundleId) => {
          modalGoal.action = action
          modalGoal.jobspec = jobspec
          modalGoal.bundleId = bundleId
          isModalOpen.value = true
        }

        /**
         * action 'install' + jobspec ->  install the jobspec
         * action 'uninstall' + jobspec -> uninstall the jobspec
         * action 'install' + bundle -> upload the bundle file
         * action 'uninstall' + bundle_id -> delete the bundle
         */
        const modalActionConfirmation = async (action, jobspec, bundleId, bundle) => {
          console.log('Modal action confirmation:', action, jobspec, bundleId, bundle)
          
          let result = null

          isLoading.value = true // Show loading state
          if (jobspec && action === 'install') {
            result = installJobspec(selectedIntegrationName.value, jobspec);
          } else if (jobspec && action === 'uninstall') {
            result = uninstallJobspec(selectedIntegrationName.value, jobspec);
          } else if (bundle && action === 'install') {
            result = uploadBundle(selectedIntegrationName.value, bundle);
          } else if (bundleId && action === 'uninstall') {
            result = await deleteBundle(selectedIntegrationName.value, bundleId);
          } else {
            console.error('No jobspec or bundleId provided for action: ', goal);
          }

          if (result) {
            displayZendeskNotification(`Successfully ${action}ed the ${jobspec ? `jobspec ${jobspec}` : `bundle ${bundleId}`}. Refreshing...`, 'success');
            // TODO - find a way to limit the refresh to the current action (ie. uploading bundle -> refreshAll but jobspec update -> refresh only bundles)
            await refreshData(); // Refresh data after action
          } else {
            displayZendeskNotification(`Failed to ${action} the ${jobspec ? jobspec : `bundle ${bundleId}`}`, 'error');
          }

          isLoading.value = false // Hide loading state
          isModalOpen.value = false // Close the modal after action
        }

        // Create Vue app
        const app = createApp({
          components: {
            JobSpecTable,
            PreviewBundleDiv,
            ActionModal
          },
          setup() {

            // TODO add stuff onmounted, beforeMounted, etc.

            onBeforeMount(() => {
              // Initial data fetch
              console.log('App mounted, fetching initial data...')
              initClient()
            })

            return {
              //App settings
              settings,
              // Data
              integrations,
              bundles,
              // UI
              isLoading,
              selectedIntegrationName,
              showJobSpecFor,
              shownBundleID,
              // Functions
              showJobspecClicked,
              showBundleClicked,
              refreshData,
              // Bundle Preview
              isPreviewExpanded,
              togglePreviewExpansion,
              copyToClipboard,
              // Modal
              isModalOpen,
              modalGoal,
              openActionModal,
              modalActionConfirmation
            }
          }
        })
        app.mount('#app-vue')
      </script>

    </div> <!-- End of container -->

  </div> <!-- End of app_vue -->

</body>

</html>